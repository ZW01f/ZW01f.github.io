---
title: "Snake keylogger deep Analysis "
classes: wide
header:
  teaser: /assets/images/malware-analysis/snake/thumbnail.png
ribbon: DodgerBlue
description: "A Deep dive into the snake keylogger Malware family "
categories:
  - Malware Analysis
toc: true
---
# Meet Snake keylogger 

Snake, also known as the 404 Keylogger and Snake Keylogger, is a sophisticated. NET-based info-stealing malware was first discovered in late 2020, commonly spread via phishing scams, and remains a major threat in 2024.

The name 'Snake' comes from strings in its log files and code. Threat actors use the snake’s builder to select features and create new attacks. This means the capabilities of different versions can vary.

Snake has evolved from basic keystroke logging to include advanced data capture capabilities. Over time, it has improved its stealth and persistence techniques. Recent campaigns have increasingly targeted critical infrastructure and used legitimate services to mask malicious activities.

# Technical in Points

- Snake operates in multiple stages, where each stage decrypts and loads the next payload. This staged approach involves using.NET assemblies and dynamic analysis to reveal the core payload. 

- Host Profiling: Snake will gather information about the infected host; it collects the following information: the PC name, date and time, client IP address, country name, country code, region name, region code, city, time zone, latitude, and longitude, which are put in the header of the collected stolen information. 

- Snake makes use of [timers](https://learn.microsoft.com/en-us/dotnet/standard/threading/timers) to execute specific tasks at regular intervals, such as repeatedly capturing keystrokes, screenshots, and clipboard contents, as well as scheduling data exfiltration to remote command-and-control servers to avoid detection. 

- Snake steals sensitive data from applications installed on infected systems, including email clients and browsers, capturing credentials and other information. It also targets FTP clients such as FileZilla and communication apps like Discord. 

- Configuration Extraction: Snake comes with embedded configuration; in this variant, the configuration is Base64 encoded and encrypted using DES with a hard-coded key. These configurations contain the host, port, username, and password, which determine the set-up used for its Command and Control (C2) to exfiltrate the gathered information.

- C2 Communication: Snake sends stolen data to its Command and Control (C2) server using various methods, including SMTP, FTP, and Telegram, in plain text or encrypted using the DES algorithm. 


# Sample Basic Information [this may change]

| SHA-256                 | faebc09f47203bbe599ac368f12622f38255e957d1435e6763c80bf2ebd988bf |
|-------------------------|-----------------------------------------------------------------|
| File info               | PE32 executable (GUI) Mono/.Net assembly                                                         |
| Target Machine          | x86                                                          |
| Creation Time           | 2082-07-25 14:24:59 UTC                                        |
| First Seen In The Wild  | 2024-06-11 18:32:45 UTC                                        |

[![](/assets/images/malware-analysis/snake/virus_total.png)](/assets/images/malware-analysis/snake/virus_total.png)
<center><font size="3"><u>Figure</u>(1): <u>sample on VirusTotal</u></font> </center> 
<br>

# Unpacking 

## Stage 1

Packed .NET samples usually hide a further-stage payload that is unpacked in memory at runtime and loaded as byte reflection without writing it to disk.

In Snake, when the main entry point is called, it creates a form (Form1). The form's constructor then loads and creates a type from the decrypted payload.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/stage_1_1.png">
    <img src="/assets/images/malware-analysis/snake/stage_1_1.png" alt="API Response Process">
  </a>
</p>

The process starts with ``Activator.CreateInstance``, which dynamically creates an instance of a type during program execution.

The type is determined through ``DefaultJsonNameTable.Anterne``, which then starts loading the second stage assembly or module using ``AppDomain.CurrentDomain.Load``. This assembly/module is decrypted from an embedded resource **(Resources.Example)** using a simple XOR encryption method with the hard-coded key <u>YPrALKXmrr</u>.


[![](/assets/images/malware-analysis/snake/stage_1_2.png)](/assets/images/malware-analysis/snake/stage_1_2.png)
<center><font size="3"><u>Figure</u>(2): <u>Decrypting the second stage</u></font> </center> 
<br>
To extract the binary after unpacking, we can do a dynamic analysis session by stepping through the code and breakpoint at the line where the module is loaded and saving it to disk; however, we could keep working with the dynamic session until we get our final payload.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/stage_1_3.png">
    <img src="/assets/images/malware-analysis/snake/stage_1_3.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(3): <u>Next stage: Example.dll is loaded into memory.</u></font> </center> 
<br>

## Stage 2

By analyzing the interesting function ``BMfMTiULrwrQOTDiGxUMZ()``, we see that it uses reflection to load an assembly and invoke a method from it dynamically. 

<p align="center">
  <a href="/assets/images/malware-analysis/snake/stage_2_1.png">
    <img src="/assets/images/malware-analysis/snake/stage_2_1.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(4): <u>Stage 2 Entry Point</u></font> </center> 
<br>

The encrypted data (Resources.AQipUvwTwkLZyiCs) is retrieved using a ResourceManager (Resources.ResourceManager) and decrypted using AES encryption with the ECB mode and a SHA-256 hashed key to get the assembly to load. 

<p align="center">
  <a href="/assets/images/malware-analysis/snake/stage_2_2.png">
    <img src="/assets/images/malware-analysis/snake/stage_2_2.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(5): <u>Decrypting the third stage</u></font> </center> 
<br>
Then,the type (class) and method to be invoked are decrypted using the same technique. 

The decryption method uses the AES encryption algorithm (``RijndaelManaged``). It initializes with a predefined salt for key derivation and uses [Rfc2898DeriveBytes](https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.rfc2898derivebytes?view=net-8.0) to derive the encryption key and IV from a provided password. 

<p align="center">
  <a href="/assets/images/malware-analysis/snake/stage_2_3.png">
    <img src="/assets/images/malware-analysis/snake/stage_2_3.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(6): <u>Decryption of the class name and method using AES. </u></font> </center> 
<br>

After loading the assembly and getting the method, the malware runs it with specific parameters. These parameters are: a PE file fetched from 'Resources.Scrivens', decrypted using the previously mentioned AES decryption method, as the first parameter, and the file path of the application's executable as the second parameter.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/stage_2_4.png">
    <img src="/assets/images/malware-analysis/snake/stage_2_4.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(7): <u>The third stage, AQipUvwTwkLZyiCs.dll, is loaded into memory. </u></font> </center> 
<br>

## Stage 3
This DLL is more obfuscated than the previous stages, and it dynamically decrypts using a simple XOR and loads APIs.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/load_api.png">
    <img src="/assets/images/malware-analysis/snake/load_api.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(8): <u>Decrypting and loading APIs</u></font> </center> 
<br>
By looking into the code, this stage uses process hollowing to inject the main Snake payload into a newly created child process and execute it to evade detection.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/inj.png">
    <img src="/assets/images/malware-analysis/snake/inj.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(9): <u>Third stage main code</u></font> </center> 
<br>
First, the file path passed as the first argument is used to start a new process in suspended mode and hollows out the memory using ``ZwUnmapViewOfSection()`` and then allocates it again using ``VirtualAllocEx()`` with <u>RWX</u> permissions.

Next, it writes the final stage executable that is passed as the first argument of the previous stage to the allocated memory region using two calls to ``WriteProcessMemory()``.

Finally, it's making the necessary modifications; the thread context is updated using ``SetThreadContext`` and the suspended thread is resumed with ``ResumeThread``, allowing the new process to run with the injected malicious code.

By dumping the data injected into the process, we can extract the final Snake payload and start examining the malware's exact behavior.

# Anti Analysis

## Code Obfuscation

Snake's final payload uses obfuscation tools like Deep Sea Obfuscator and Ben-Mhenni-Protector to make its code quite challenging to understand. The names of classes and functions are scrambled, making the code difficult to analyze.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/obfuscation.png">
    <img src="/assets/images/malware-analysis/snake/obfuscation.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(10): <u>Obfuscated Code</u></font> </center> 
<br>
To better understand the code, we can use the tool <u>de4dot</u> to de-obfuscate the payload file. This made the code easier to read, allowing us to analyze it more effectively.

## Date check

Snake checks the current date it runs on to ensure that if a specified date has passed, then the executable will schedule its deletion to avoid detection or analysis.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/check_date.png">
    <img src="/assets/images/malware-analysis/snake/check_date.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(11): <u>Date check and self-deletion </u></font> </center> 
<br>

## Detect Analysis Environment

Snake uses specific IP addresses to check for monitoring or analysis. If these IPs are detected, the malware alters its behavior to avoid detection. If the environment is considered clean, the malware sends the collected data to its server.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/anti_env.png">
    <img src="/assets/images/malware-analysis/snake/anti_env.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(12): <u>Check for Analysis Environment</u></font> </center> 
<br>

## Checking Processes

Snake loops through running processes on the system and compares their executable names against a list of processes that are generally associated with antivirus software, firewalls, network monitoring tools, and other security-related applications and malware analysis tools, and terminates any running processes whose names match any of those listed.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/process_check.png">
    <img src="/assets/images/malware-analysis/snake/process_check.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(13): <u>Check running processes</u></font> </center> 
<br>
**full processes list**
<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br>
        &emsp; zlclient<br>
        &emsp; egui<br>
        &emsp; bdagent<br>
        &emsp; wireshark<br>
        &emsp; olydbg<br>
    </summary>
    &emsp; anubis<br>
    &emsp; npfmsg<br>
    &emsp; avastui<br>
    &emsp; _Avp32<br>
    &emsp; vsmon<br>
    &emsp; mbam<br>
    &emsp; keyscrambler<br>
    &emsp; _Avpcc<br>
    &emsp; _Avpm<br>
    &emsp; Ackwin32<br>
    &emsp; Outpost<br>
    &emsp; Anti-Trojan<br>
    &emsp; ANTIVIR<br>
    &emsp; Apvxdwin<br>
    &emsp; ATRACK<br>
    &emsp; Autodown<br>
    &emsp; Avconsol<br>
    &emsp; Ave32<br>
    &emsp; Avgctrl<br>
    &emsp; Avkserv<br>
    &emsp; Avnt<br>
    &emsp; Avp<br>
    &emsp; Avp32<br>
    &emsp; Avpcc<br>
    &emsp; Avpdos32<br>
    &emsp; Avpm<br>
    &emsp; Avptc32<br>
    &emsp; Avpupd<br>
    &emsp; Avsched32<br>
    &emsp; AVSYNMGR<br>
    &emsp; Avwin95<br>
    &emsp; Avwupd32<br>
    &emsp; Blackd<br>
    &emsp; Blackice<br>
    &emsp; Cfiadmin<br>
    &emsp; Cfiaudit<br>
    &emsp; Cfinet<br>
    &emsp; Cfinet32<br>
    &emsp; Claw95<br>
    &emsp; Claw95cf<br>
    &emsp; Cleaner<br>
    &emsp; Cleaner3<br>
    &emsp; Defwatch<br>
    &emsp; Dvp95<br>
    &emsp; Dvp95_0<br>
    &emsp; Ecengine<br>
    &emsp; Esafe<br>
    &emsp; Espwatch<br>
    &emsp; F-Agnt95<br>
    &emsp; Findviru<br>
    &emsp; Fprot<br>
    &emsp; F-Prot<br>
    &emsp; F-Prot95<br>
    &emsp; Fp-Win<br>
    &emsp; Frw<br>
    &emsp; F-Stopw<br>
    &emsp; Iamapp<br>
    &emsp; Iamserv<br>
    &emsp; Ibmasn<br>
    &emsp; Ibmavsp<br>
    &emsp; Icload95<br>
    &emsp; Icloadnt<br>
    &emsp; Icmon<br>
    &emsp; Icsupp95<br>
    &emsp; Icsuppnt<br>
    &emsp; Iface<br>
    &emsp; Iomon98<br>
    &emsp; Jedi<br>
    &emsp; Lockdown2000<br>
    &emsp; Lookout<br>
    &emsp; Luall<br>
    &emsp; MCAFEE<br>
    &emsp; Moolive<br>
    &emsp; Mpftray<br>
    &emsp; N32scanw<br>
    &emsp; NAVAPSVC<br>
    &emsp; NAVAPW32<br>
    &emsp; NAVLU32<br>
    &emsp; Navnt<br>
    &emsp; NAVRUNR<br>
    &emsp; Navw32<br>
    &emsp; Navwnt<br>
    &emsp; NeoWatch<br>
    &emsp; NISSERV<br>
    &emsp; Nisum<br>
    &emsp; Nmain<br>
    &emsp; Normist<br>
    &emsp; NORTON<br>
    &emsp; Nupgrade<br>
    &emsp; Nvc95<br>
    &emsp; Outpost<br>
    &emsp; Padmin<br>
    &emsp; Pavcl<br>
    &emsp; Pavsched<br>
    &emsp; Pavw<br>
    &emsp; PCCIOMON<br>
    &emsp; PCCMAIN<br>
    &emsp; Pccwin98<br>
    &emsp; Pcfwallicon<br>
    &emsp; Persfw<br>
    &emsp; POP3TRAP<br>
    &emsp; PVIEW95<br>
    &emsp; Rav7<br>
    &emsp; Rav7win<br>
    &emsp; Rescue<br>
    &emsp; Safeweb<br>
    &emsp; Scan32<br>
    &emsp; Scan95<br>
    &emsp; Scanpm<br>
    &emsp; Scrscan<br>
    &emsp; Serv95<br>
    &emsp; Smc<br>
    &emsp; SMCSERVICE<br>
    &emsp; Snort<br>
    &emsp; Sphinx<br>
    &emsp; Sweep95<br>
    &emsp; SYMPROXYSVC<br>
    &emsp; Tbscan<br>
    &emsp; Tca<br>
    &emsp; Tds2-98<br>
    &emsp; Tds2-Nt<br>
    &emsp; TermiNET<br>
    &emsp; Vet95<br>
    &emsp; Vettray<br>
    &emsp; Vscan40<br>
    &emsp; Vsecomr<br>
    &emsp; Vshwin32<br>
    &emsp; Vsstat<br>
    &emsp; Webscanx<br>
    &emsp; WEBTRAP<br>
    &emsp; Wfindv32<br>
    &emsp; Zonealarm<br>
    &emsp; LOCKDOWN2000<br>
    &emsp; RESCUE32<br>
    &emsp; LUCOMSERVER<br>
    &emsp; avgcc<br>
    &emsp; avgamsvr<br>
    &emsp; avgupsvc<br>
    &emsp; avgw<br>
    &emsp; avgcc32<br>
    &emsp; avgserv<br>
    &emsp; avgserv9<br>
    &emsp; avgserv9schedapp<br>
    &emsp; avgemc<br>
    &emsp; ashwebsv<br>
    &emsp; ashdisp<br>
    &emsp; ashmaisv<br>
    &emsp; ashserv<br>
    &emsp; aswUpdSv<br>
    &emsp; symwsc<br>
    &emsp; norton<br>
    &emsp; Norton Auto-Protect<br>
    &emsp; norton_av<br>
    &emsp; nortonav<br>
    &emsp; ccsetmgr<br>
    &emsp; ccevtmgr<br>
    &emsp; avadmin<br>
    &emsp; avcenter<br>
    &emsp; avgnt<br>
    &emsp; avguard<br>
    &emsp; avnotify<br>
    &emsp; avscan<br>
    &emsp; guardgui<br>
    &emsp; nod32krn<br>
    &emsp; nod32kui<br>
    &emsp; clamscan<br>
    &emsp; clamTray<br>
    &emsp; clamWin<br>
    &emsp; freshclam<br>
    &emsp; oladdin<br>
    &emsp; sigtool<br>
    &emsp; w9xpopen<br>
    &emsp; Wclose<br>
    &emsp; cmgrdian<br>
    &emsp; alogserv<br>
    &emsp; mcshield<br>
    &emsp; vshwin32<br>
    &emsp; avconsol<br>
    &emsp; vsstat<br>
    &emsp; avsynmgr<br>
    &emsp; avcmd<br>
    &emsp; avconfig<br>
    &emsp; licmgr<br>
    &emsp; sched<br>
    &emsp; preupd<br>
    &emsp; MsMpEng<br>
    &emsp; MSASCui<br>
    &emsp; Avira.Systray<br>
</details>

<br>

# Main Snake Functionality

## Host Profiling

Snake builds a detailed profile of the infected system; it gathers important details from infected machines, starting with basic information like the machine's name and current date/time. Also, it retrieves sensitive geolocation data such as the machine's public IP address, country name/code, region name/code, city name, time zone, and precise latitude and longitude coordinates.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/get_sys_info.png">
    <img src="/assets/images/malware-analysis/snake/get_sys_info.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(14): <u>Host profiling of the compromised machine</u></font> </center> 
<br>

## KeyLogging

Snake performs keylogging and employs a timer to periodically send this data to its command-and-control (C2) server.

In programming, timers run a specific piece of code at regular intervals. In .NET, the ``System.Windows.Forms.Timer`` class is often used in Windows Forms applications to trigger events at set intervals.

Timers allow asynchronous execution, enabling actions to happen independently of the main program's flow.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/keylog_1.png">
    <img src="/assets/images/malware-analysis/snake/keylog_1.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(15): <u>Timer used for sending keylogs
</u></font> </center> 
<br>

Snake's keylogger runs continuously in the background by using the ``SetWindowsHookExA`` API to set up a Windows hook ``_hook)``. This hook monitors keyboard events and integrates itself into the keyboard hook chain. The hook is associated with the callback method ``_hookCallback``, which handles keyboard events. Whenever a key is pressed, this callback function is triggered. It records the keystroke and then forwards the call to the next hook in the chain.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/keylog_2.png">
    <img src="/assets/images/malware-analysis/snake/keylog_2.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(16): <u>Keylogger function</u></font> </center> 
<br>

It also regularly monitors and logs the title of the active window in the foreground using APIs like ``GetForegroundWindow()`` and ``GetWindowText()``. By recording the active window's title alongside keystrokes, the keylogger gains valuable context about where and when the keystrokes occur. This is important for improving the information captured by the keylogger and helping the attacker understand what apps or windows are in use when the user types.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/keylog_3.png">
    <img src="/assets/images/malware-analysis/snake/keylog_3.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(17): <u>Capture the title of the current active window.</u></font> </center> 
<br>

## Screenshot

Snake periodically captures screenshots of the user's screen, which may capture sensitive information such as documents or login credentials, saving them initially as “Screenshot.jpg” in a folder  “SnakeKeylogger” within the user's Documents directory. The captured images are stored until they are sent to the attacker before they are deleted from the system. This process is triggered by a timer set to run every 100 milliseconds.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/keylog_3.png">
    <img src="/assets/images/malware-analysis/snake/keylog_3.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(18): <u>hashdb result</u></font> </center> 

## Clipboard
Snake uses a timer to capture and process clipboard contents. It retrieves text from the clipboard using ``Class2.Class1_0.Clipboard. GetText()`` checks if the text is already stored in a global variable before adding it, to ensure that each unique clipboard entry is logged only once. Periodically, another timer sends the collected clipboard data to a Command and Control (C2) server. This capability allows Snake to capture sensitive information, such as passwords or credit card numbers, that users have copied.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/clipboard.png">
    <img src="/assets/images/malware-analysis/snake/clipboard.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(19): <u>Capture and parse clipboard contents.</u></font> </center> 

## Steal Email Clients credentials

Snake retrieves Outlook email credentials from Microsoft Outlook profiles stored in the Windows Registry and gets values associated with various email protocols such as IMAP, POP3, HTTP, and SMTP. If these values are found, it decrypts the passwords using a helper method and retrieves the associated email addresses and email information.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/outlook.png">
    <img src="/assets/images/malware-analysis/snake/outlook.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(20): <u>Extract and log Outlook's credentials</u></font> </center> 
<br>

With a similar method, Snake targets Foxmail to extract stored credentials by retrieving the Foxmail installation path from the registry and constructing the path to the storage directory where account information is stored. It loops through the directories within Storage, looking for ``Account.rec0`` files that contain account credentials (e-mail and password).

| Path                                                                                     | Description                                |
|------------------------------------------------------------------------------------------|--------------------------------------------|
| `SOFTWARE\Microsoft\Office\15.0\Outlook\Profiles\Outlook\9375CFF0413111d3B88A00104B2A6676` | Outlook profile registry (Office 15.0)     |
| `SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows Messaging Subsystem\Profiles\Outlook\9375CFF0413111d3B88A00104B2A6676` | Outlook profile registry (Windows NT)      |
| `SOFTWARE\Microsoft\Windows Messaging Subsystem\Profiles\9375CFF0413111d3B88A00104B2A6676` | Messaging profiles (Windows)               |
| `SOFTWARE\Microsoft\Office\16.0\Outlook\Profiles\Outlook\9375CFF0413111d3B88A00104B2A6676` | Outlook profile registry (Office )     |
| `SOFTWARE\Classes\Foxmail.url.mailto\Shell\open\command`                                 | Foxmail registry       |
| `\\Accounts\\Account.rec0`                                                               | Account data file path                     |
          |

The extracted information is then formatted and appended to the stolen info global variable to be sent to the attacker.

## Steal Browsers Credentials

Browsers store saved login credentials in encrypted files. Snake has a predefined list of common browsers and checks for their existence on the system. It can access these storage locations to extract these credentials and send them to the attacker.

### Chromium-based browsers

Chromium-based browsers, such as Chrome, use SQLite databases to store saved login credentials in a file called 'Login Data' in the user's profile directory.

Snake scans the system for browser profiles and accesses the SQLite databases used by these browsers, then parses the 'logins' table within the SQLite database, iterating through each row to retrieve the website URL (origin_url), the username (username_value), and the encrypted password (password_value). Depending on the encryption version, it tries to decrypt passwords. Both the username and decrypted password are formatted into a string and appended to the stolen info global variable to be sent to the attacker.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/browsers_1.png">
    <img src="/assets/images/malware-analysis/snake/browsers_1.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(21): <u>Extract and decrypt the Chrome credential.</u></font> </center> 
<br>

The full list of browsers : 
<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br>
        &emsp; Google Chrome<br>
        &emsp; Chrome Canary<br>
        &emsp; BraveSoftware (Brave-Browser)<br>
        &emsp; 360Browser <br>
        &emsp; Chromium <br>
    </summary>
    &emsp; Kinza<br>
    &emsp; Falkon<br>
    &emsp; CoolNovo<br>
    &emsp; QIPSurf<br>
    &emsp; BlackHawk<br>
    &emsp; 7Star<br>
    &emsp; Citrio<br>
    &emsp; Coowon<br>
    &emsp; CocCoc<br>
    &emsp; Uran<br>
    &emsp; Orbitum<br>
    &emsp; Slimjet<br>
    &emsp; Iridium<br>
    &emsp; Vivaldi<br>
    &emsp; Iron<br>
    &emsp; Ghost<br>
    &emsp; Cent<br>
    &emsp; Xvast<br>
    &emsp; Chedot<br>
    &emsp; SuperBird<br>
    &emsp; Opera <br>
    &emsp; 360Secure<br>
    &emsp; Comodo<br>
    &emsp; Torch<br>
    &emsp; UCBrowser<br>
    &emsp; Blisk<br>
    &emsp; EpicPrivacyBrowser<br>
    &emsp; Yandex<br>
    &emsp; Nichrome<br>
    &emsp; Amigo<br>
    &emsp; Kometa<br>
    &emsp; Xpom<br>
    &emsp; Elements<br>
    &emsp; SalamWeb<br>
    &emsp; Sputnik (browser/extension)<br>
    &emsp; Liebao7 (Liebao Browser)<br>
    &emsp; AVASTSoftware (Avast Browser)<br>
</details>
### Gecko-based browsers
Gecko-based browsers use JSON files to store saved login credentials in 'logins.json'.

Snake scans directories to find profiles of Gecko-based browsers, such as Firefox. Then, it accesses the logins.json file within each profile directory, which stores encrypted login credentials, including usernames and passwords. 

<p align="center">
  <a href="/assets/images/malware-analysis/snake/browser_2.png">
    <img src="/assets/images/malware-analysis/snake/browser_2.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(22): <u>Extract and decrypt the Mozilla browser credential.</u></font> </center> 
<br>

It decrypts these credentials using cryptographic libraries (mozglue.dll and nss3.dll), which are dynamically loaded from the installation directories of Mozilla Firefox and related browsers. Once loaded, these libraries enable Snake to initialize the NSS (Network Security Services) library, creating the necessary cryptographic contexts that decrypt and extract usernames and passwords. 

<p align="center">
  <a href="/assets/images/malware-analysis/snake/browser_3.png">
    <img src="/assets/images/malware-analysis/snake/browser_3.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(23): <u>Snake tries to load moazglue.dll and nss3.dll by checking installed paths.
</u></font> </center> 
<br>

The decrypted information is formatted into strings and appended to the stolen info global variable to be sent to the attacker.

> The full list of Gecko-based browsers is : 
- Mozilla Firefox
- SeaMonkey
- IceDragon
- Cyberfox
- Pale Moon
- Waterfox
- icecat

## Steal FTP clients credentials 
The FileZilla software program is a free-to-use (open source) FTP utility, allowing a user to transfer files from a local computer to a remote computer.

FileZilla is targeted by Snake to get the saved configurations of previously accessed servers.By parsing the ``recentservers.xml`` file located in the user's AppData directory, it tries to retrieve stored server details such as hostnames, usernames, encrypted passwords, and ports. It uses XML parsing techniques to extract these elements and decrypt the Base64-encoded password.

<p align="center">
  <a href="/assets/images/malware-analysis/snake/steal_ftp.png">
    <img src="/assets/images/malware-analysis/snake/steal_ftp.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(24): <u>Extract and log FileZilla info.</u></font> </center> 
<br>

## Obtain discord tokens
Discord uses a token-based authentication system. Each user session is identified by a token that is stored locally. By accessing the <u>leveldb</u> files, Snake can extract these tokens and use them to mimic the user, gaining access to their account without needing their password. This can lead to unauthorized access to personal messages, servers, and other sensitive information.

The code checks if the ``leveldb`` directory exists. If found, it iterates through its files to locate ``.ldb`` files containing the substring "oken" (part of "token"). It then extracts the token by splitting the text around the "oken" substring and reassembling the parts to separate the token. Finally, it logs the result to be sent to the attacker.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/discord.png">
    <img src="/assets/images/malware-analysis/snake/discord.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(25): <u>Steal discrod login tokens </u></font> </center> 
  
## Stealing Wi-Fi Credentials:
Snake extracts Wi-Fi profile information and passwords using ``netsh`` commands. It starts by fetching a list of Wi-Fi profiles on the system.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/wifi_1.png">
    <img src="/assets/images/malware-analysis/snake/wifi_1.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(26): <u>Retrieve Wi-Fi profiles on the system.</u></font> </center> 
<br>
Then it parses each profile to retrieve its name and clear-text password. This information is logged and sent to the attacker.
<p align="center">
  <a href="/assets/images/malware-analysis/snake/wifi_2.png">
    <img src="/assets/images/malware-analysis/snake/wifi_2.png" alt="API Response Process">
  </a>
</p>
<center><font size="3"><u>Figure</u>(27): <u>Extracting and Formatting Wi-Fi Profile Passwords.</u></font> </center> 
<br>
By gathering Wi-Fi credentials, Snake can secretly connect to networks, monitor traffic for sensitive data, and get access to activities like botnet operations or data theft.


# Snake's C2 Functionality 

## Configuration Extraction
Snake contains an embedded DES-encrypted configuration within its binary. 

[![](/assets/images/malware-analysis/snake/config_1.png)](/assets/images/malware-analysis/snake/config_1.png)
<center><font size="3"> <u>Figure(28)</u>: Encrypted configuration  </font></center> 
<br>

Snake malware uses embedded DES in ECB mode encryption with a hard-coded key. It first decodes the data using Base64 encoding. For decryption, it hashes the key using MD5 and uses only the first 8 bytes of the hashed key as the final key to decrypt the data.

[![](/assets/images/malware-analysis/snake/config_2.png)](/assets/images/malware-analysis/snake/config_2.png)
<center><font size="3"> <u>Figure(29)</u>: Encrypted Algortihms used in configuration  </font></center> 
<br>

We can use CyberChef to simulate the decryption process statically. First, the key will be MD5 hashed = {6fc98cd68a1aab8b24c517549e658115}, and the first 8 bytes are used to decrypt the data. 

[![](/assets/images/malware-analysis/snake/dec_config.png)](/assets/images/malware-analysis/snake/dec_config.png)
<center><font size="3"> <u>Figure(30)</u>: The actual decrypted configuration the malware uses.</font></center> 
<br>

These configurations determine the setup used by the sample for its Command and Control (C2). 

> - the host set to 'valleycountysar[.]org' .
- port:'26'. 
- username :  'rightlut@valleycountysar[.]org' .
- password 'fY,FLoadtsiF' .

## Data Exfiltration

Malware needs to connect to C2 servers to exfiltrate stolen data.

Snake can transmit gathered information in plaintext or DES-encrypted format to its Command and Control (C2) server through several communication methods, including SMTP, FTP, or even sending it to a specific Telegram bot.

### SMTP 
Snake uses SMTP (Simple Mail Transfer Protocol) in two different approaches for data exfiltration.

The first approach creates an email (a mail message) with the following configurations: sender, recipient, subject (including PC name and a tracking identifier), and a body containing stolen information. This email is sent using an SmtpClient configuration: host, port, and authentication credentials (username and password).

<p align="center">
    <img src="/assets/images/malware-analysis/snake/smtp_1.png" alt="API Response Process">
</p>
<center><font size="3"> <u>Figure</u>(31): <u>Using SMTP for data exfiltration, the body mail approach </u></font> </center>
<br>

The second approach is to create an email (MailMessage2) with similar sender and recipient details. But instead of adding data directly, it attaches files containing stolen information. This method also uses an SmtpClient2 configured similarly to the first way.

<p align="center">
    <img src="/assets/images/malware-analysis/snake/smtp_2.png" alt="API Response Process">
</p>
<center><font size="3"> <u>Figure</u>(32): <u>Using SMTP for data exfiltration (attachments) </u></font> </center>

### FTP

The FTP request is configured with credentials (user name and password) to authenticate access to the FTP server and a dynamic method to create an ``FtpWebRequest``. It builds a filename by combining the machine name with a random string and adding a.txt extension that helps uniquely identify the data.

<p align="center">
    <img src="/assets/images/malware-analysis/snake/ftp.png" alt="API Response Process">
</p>
<center><font size="3"> <u>Figure</u>(33): <u>Using FTP for data exfiltration</u></font> </center>

### Telegram 

The process starts by creating a message containing stolen information, which is URL-encoded, and preparing it for encoding in the POST request data. The encoded message, along with specified parameters, forms the POST data sent via a WebRequest to a server endpoint where the encoded message is directed for transmission.

<p align="center">
    <img src="/assets/images/malware-analysis/snake/telegram.png" alt="API Response Process">
</p>
<center><font size="3"> <u>Figure</u>(34): <u>Using telegram bot for data exfiltration</u></font> </center>
<br>


# Persistence 

Snake adds a startup entry to the Windows Registry, ensuring that the malware runs automatically on the system boot.

<p align="center">
    <img src="/assets/images/malware-analysis/snake/persistence.png" alt="API Response Process">
</p>
<center><font size="3"> <u>Figure</u>(22): <u>Persistence function</u></font> </center>
<br>
# Conclusion

Analyzing Snake revealed its true purpose as a sophisticated keylogger and data stealer that targets sensitive data from various applications like browers, email clients, FTP clients, and messaging apps, demonstrating its broad data theft capabilities.

<br>
# YARA Rule

```css
rule detect_unpacked_snake
{
    meta:
        description = "A rule for detecting unpacked snake samples"
        author = "Mohamed Ezzat (@ZW01f)"
        hash1  = "e81ff60c955d9f232d4812a68ef4335f204be923d6aa75c5d309e8fe76eed1ed"
        hash2  = "fc20db86eea0db054491e5739e93153c5548ed933e0df6a139582e0b8569e737"
        hash3  = "461bcd6658a32970b9bd12d978229b8d3c8c1f4bdf00688db287b2b7ce6c880e"
    strings:

       $mz = {4D 5A}           //PE File
       $s0 = "YFGGCVyufgtwfyuTGFWTVFAUYVF" ascii wide
       $s1 = "Snake Keylogger Stub New" ascii wide
       $s2 = "\\SnakeKeylogger" wide
       $s3 = "Open Network" ascii wide
       $s4 = "- Clipboard Logs ID -" ascii wide
       $s5 = "| Snake Tracker" wide
       $s6 = "/C choice /C Y /N /D Y /T 3 & Del \"" ascii wide 
       $s7 = "wlan show profile" ascii wide
       $p1 = {1D 8D ?? 00 00 01 25 16 72 ?? ?? 00 70 A2 25 17 09 A2 25 18 72 ?? ?? 00 70 A2 25 19 11 04 A2 25 1A 72 ?? ?? 00 70 A2 25 1B 11 05 A2 25 1C 72 ?? ?? 00 70 A2 28 ?? 00 00 0A 13 0D} // pattern used in sending info
    condition:  
        ($mz at 0) and (all of ($p*)) and (5 of ($s*)) and filesize < 500KB
} 
```

```css
rule detect_packed_snake
{
    meta:
        description = "A rule for detecting packed snake samples"
        author = "Mohamed Ezzat (@ZW01f)"
        hash1  = "62df71d0bae729795227435a055a649583d55ce89cd8d3198cdc88752bcd4080"
        hash2  = "491feafd2754f97c917a353e645d7c1271bff8549f51158e7a0296b9514fe7c1"
    strings:

       $mz = {4D 5A}           //PE File
       $s0 = "Example"
       $s1 = "EfkQkZyBfffTrJOZZOvJL" ascii wide
       $s2 = "CZGwDCEsywxZZUZfkyhhx" ascii wide
       $p1 = {00 06 07 7E 04 00 00 04 07 91 02 07 ?? 8E 69 5D 91 61 D2 9C} // decyption pattern
       $p2 = {28 05 00 00 06 80 04 00 00 04} 
    condition:  
        ($mz at 0) and (2 of ($s*)) and (1 of ($p*)) and filesize < 1MB
} 

 
```

<br>

# IoCs [may add some more ]

| Stage      | Hash                                                              |
|------------|-----------------------------------------------------------------|
| Stage 1    | faebc09f47203bbe599ac368f12622f38255e957d1435e6763c80bf2ebd988bf |
| Stage 2    | 8a520450581de3e9987f53c54723fdf9d4af32571769c49af7c18d985ef52fb0 |
| Stage 3    | 45c7b64a55dca23ee1239649e03a7c361813dbcfc2a0817b0d8e94c907d6ed4b |
| Main payload | 68df92cd19e5587a799a54bc21ddd95a27223faf972c6a914c818c99d3332a84 |


# References

- [Researchers Uncover SnakeKeylogger Attacks, Techniques & Tactics](https://cybersecuritynews.com/researchers-uncover-snakekeylogger/)
- [https://any.run/cybersecurity-blog/analyzing-snake-keylogger/](https://any.run/cybersecurity-blog/analyzing-snake-keylogger/)